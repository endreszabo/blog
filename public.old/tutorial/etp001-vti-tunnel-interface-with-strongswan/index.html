<!doctype html><title>VTI Tunnel Interface with strongSwan :: end.re</title><link href rel=alternate type=application/rss+xml title=end.re><link rel="shortcut icon" href=/favicon.png><link href=/a/s.css media=screen rel=stylesheet><script>const enable_comments=function(){document.getElementById("button_enable_comments").style.display='none';var disqus_config=function(){this.page.url="https://end.re/etp001/";this.page.identifier="etp001";};var d=document,s=d.createElement('script');s.src='https://endreszabo.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);}</script><link href=http://gmpg.org/xfn/11 rel=profile><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png href=/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicon-16x16.png sizes=16x16><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=theme-color content=#fafafa><meta property=og:title content="VTI Tunnel Interface with strongSwan"><meta property=og:description content="yet another tech blog with underdeveloped thoughts, quick and dirty tips and tricks, random ramblings"><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content=https://end.re/tutorial/etp001-vti-tunnel-interface-with-strongswan/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="yet another tech blog with underdeveloped thoughts, quick and dirty tips and tricks, random ramblings"><meta name=keywords content=ipsec,strongswan><meta name=author content="Endre Szabo"><meta name=generator content="Hugo 0.40.2"><header class=header-main><div class=logo><a title=end.re href=https://end.re><img src=/images/el.svg alt=logo width=90 class=logo-main></a></div><div class=nav><nav class=main-nav><ul><li><a href=/blog/>Blog</a><li><a href=/tutorial/>Tutorials</a><li><a href=/about/>About</a></ul></nav></div></header><main class=wrapper-main><section class=wrapper-content><section class=post-index itemscope itemtype=http://schema.org/BlogPosting><article class=post-content><div class=post-header><h2 class=post-title itemprop=name>VTI Tunnel Interface with strongSwan</h2><span class=a-meta><a class=category-tutorial href=/categories/tutorial/>tutorial</a></span>
<span class=m-split><a class=tag-ipsec href=/tags/ipsec/>#ipsec</a>,
<a class=tag-strongswan href=/tags/strongswan/>#strongswan</a></span>
<time class=m-split datetime=2015-01-06T00:00:00&#43;00:00>Jan 6th, 2015</time></div><div class="entry-content full-article" itemprop=articleBody><p>I successfully managed to get Linux VTI (Virtual Tunnel Interface) working with strongSwan. By using VTI it is no longer needed to rely on the routing policy database, making understanding and maintaining routes easier. Also with VTI you can see the cleartext traffic on the VTI interface itself. It was confusing to see actual tunnel traffic before using <code>tcpdump</code> using the standard policy database setup. (There are <code>ulog</code>/<code>nflog</code> hacks to see cleartext traffic in both direction though, similar to BSD <code>pflog</code>.)<p>With policy database strongSwan installs its learned policy routes to a separate routing table having preference over the main routing table. strongSwan does not support native VTI setup so a <code>&lt;left|right&gt;updown</code> script is needed to setup the tunnel this way.<p>So far the <code>/usr/local/sbin/ipsec-notify.sh</code> file looks like this:<div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=nb>set</span> -o nounset
<span class=nb>set</span> -o errexit

<span class=nv>VTI_IF</span><span class=o>=</span><span class=s2>&#34;vti</span><span class=si>${</span><span class=nv>PLUTO_UNIQUEID</span><span class=si>}</span><span class=s2>&#34;</span>

<span class=k>case</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PLUTO_VERB</span><span class=si>}</span><span class=s2>&#34;</span> in
    up-client<span class=o>)</span>
        ip tunnel add <span class=s2>&#34;</span><span class=si>${</span><span class=nv>VTI_IF</span><span class=si>}</span><span class=s2>&#34;</span> mode vti <span class=se>\
</span><span class=se></span>			<span class=nb>local</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PLUTO_ME</span><span class=si>}</span><span class=s2>&#34;</span> remote <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PLUTO_PEER</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span><span class=se></span>            okey <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PLUTO_MARK_OUT</span><span class=p>%%/*</span><span class=si>}</span><span class=s2>&#34;</span> ikey <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PLUTO_MARK_IN</span><span class=p>%%/*</span><span class=si>}</span><span class=s2>&#34;</span>
        ip link <span class=nb>set</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>VTI_IF</span><span class=si>}</span><span class=s2>&#34;</span> up
        ip addr add <span class=si>${</span><span class=nv>PLUTO_MY_SOURCEIP</span><span class=si>}</span> dev <span class=s2>&#34;</span><span class=si>${</span><span class=nv>VTI_IF</span><span class=si>}</span><span class=s2>&#34;</span>
        ip route add &lt;tunneled-network&gt; dev <span class=s2>&#34;</span><span class=si>${</span><span class=nv>VTI_IF</span><span class=si>}</span><span class=s2>&#34;</span>
        sysctl -w <span class=s2>&#34;net.ipv4.conf.</span><span class=si>${</span><span class=nv>VTI_IF</span><span class=si>}</span><span class=s2>.disable_policy=1&#34;</span>
        <span class=p>;;</span>
    down-client<span class=o>)</span>
        ip tunnel del <span class=s2>&#34;</span><span class=si>${</span><span class=nv>VTI_IF</span><span class=si>}</span><span class=s2>&#34;</span>
        <span class=p>;;</span>
<span class=k>esac</span></code></pre></div><p>and the relevant part of <code>/etc/ipsec.conf</code> looks like this (without authentication method details):<div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>conn</span> <span class=o>&lt;</span><span class=n>vpngw</span><span class=o>&gt;</span>
    <span class=n>leftupdown</span><span class=o>=/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>ipsec</span><span class=o>-</span><span class=n>notify</span><span class=o>.</span><span class=n>sh</span>
    <span class=n>left</span><span class=o>=%</span><span class=n>defaultroute</span>
    <span class=n>leftsourceip</span><span class=o>=%</span><span class=n>config4</span><span class=p>,</span><span class=o>%</span><span class=n>config6</span>
    <span class=n>rightsubnet</span><span class=o>=</span><span class=mf>0.0</span><span class=o>.</span><span class=mf>0.0</span><span class=o>/</span><span class=mi>0</span><span class=p>,::</span><span class=o>/</span><span class=mi>0</span>
    <span class=n>right</span><span class=o>=&lt;</span><span class=n>vpngw_ip</span><span class=o>&gt;</span>
    <span class=n>rightid</span><span class=o>=&lt;</span><span class=n>vpngw_id</span><span class=o>&gt;</span>
    <span class=n>auto</span><span class=o>=</span><span class=n>route</span>
    <span class=n>mark</span><span class=o>=</span><span class=mi>2</span></code></pre></div><p>In <code>/etc/strongswan.d/charon.conf</code> uncomment <code>install_routes</code> and <code>install_virtual_ip</code> properties and change their value to <code>no</code>:<div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Install routes into a separate routing table for established IPSec tunnels.
</span><span class=c1></span><span class=nv>install_routes</span> <span class=o>=</span> no

<span class=c1># Install virtual IP addresses.
</span><span class=c1></span><span class=nv>install_virtual_ip</span> <span class=o>=</span> no</code></pre></div><h5 id=update>Update</h5><p>Thermi has turned this blog post and other related informations into a <a href=https://wiki.strongswan.org/projects/strongswan/wiki/RouteBasedVPN target=_blank>strongSwan wiki entry</a>. Please be sure to check that out too.</div></article></section><hr><section id=comments><h2 class=title>Your opinion mattersâ€”be heard</h2><button id=button_enable_comments class=comments-toggle onclick=enable_comments();>Click to show comments</button><div id=disqus_thread aria-live=polite><noscript><p>I respect your privacy. In general JavaScript is not required at all to view this site properly. However, if you are interested in comments please enable running of JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by my outsourced comment section provider Disqus.</a></p></noscript></div></section></section></section><footer id=footer class=inner><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/images/cc-by-sa-4-0.png></a><br>Website contents at end.re by Endre Szabo are licensed under the <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-ShareAlike 4.0 International License</a> unless stated otherwise.</footer></main>